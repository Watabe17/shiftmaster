# 04_データモデル設計書.md

## 概要
本文書では、ShiftMasterのデータベース設計について詳細に定義します。Supabase（PostgreSQL）を使用し、マルチテナント対応、認証機能、リアルタイム機能を考慮したテーブル構成となっています。

## データベース概要
- **データベース**: PostgreSQL (Supabase)
- **ORM**: Prisma
- **認証**: Supabase Auth
- **リアルタイム**: Supabase Realtime
- **ストレージ**: Supabase Storage
- **文字コード**: UTF-8
- **タイムゾーン**: Asia/Tokyo

## テーブル一覧

### 1. 店舗管理テーブル

#### stores（店舗）
```sql
CREATE TABLE stores (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  email VARCHAR(255),
  latitude DECIMAL(10, 8),
  longitude DECIMAL(11, 8),
  radius_meters INTEGER DEFAULT 50,
  timezone VARCHAR(50) DEFAULT 'Asia/Tokyo',
  business_hours JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE
);
```

**フィールド詳細**:
- `business_hours`: 営業時間（月〜日の営業時間をJSONで保存）
- `radius_meters`: 位置認証の許可範囲（メートル）
- `latitude/longitude`: GPS座標

**サンプルデータ**:
```json
{
  "business_hours": {
    "monday": {"open": "08:00", "close": "22:00"},
    "tuesday": {"open": "08:00", "close": "22:00"},
    "wednesday": {"open": "08:00", "close": "22:00"},
    "thursday": {"open": "08:00", "close": "22:00"},
    "friday": {"open": "08:00", "close": "22:00"},
    "saturday": {"open": "09:00", "close": "21:00"},
    "sunday": {"open": "09:00", "close": "21:00"}
  }
}
```

#### store_settings（店舗設定）
```sql
CREATE TABLE store_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  auto_break_enabled BOOLEAN DEFAULT false,
  auto_break_start_hours DECIMAL(3,1) DEFAULT 6.0,
  auto_break_duration_minutes INTEGER DEFAULT 60,
  overtime_threshold_minutes INTEGER DEFAULT 480,
  early_clock_in_minutes INTEGER DEFAULT 30,
  late_clock_out_minutes INTEGER DEFAULT 30,
  location_strict_mode BOOLEAN DEFAULT true,
  notification_settings JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2. ユーザー・従業員管理テーブル

#### users（ユーザー）- Supabase Auth連携
```sql
-- Supabase Authが管理するauth.usersと連携
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email VARCHAR(255),
  full_name VARCHAR(100),
  avatar_url TEXT,
  phone VARCHAR(20),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### employees（従業員）
```sql
CREATE TABLE employees (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES user_profiles(id) ON DELETE SET NULL,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  employee_code VARCHAR(20) UNIQUE NOT NULL,
  full_name VARCHAR(100) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(20),
  role employee_role DEFAULT 'employee',
  status employee_status DEFAULT 'active',
  hire_date DATE,
  position_id UUID REFERENCES positions(id),
  hourly_wage DECIMAL(8,0),
  monthly_limit_hours INTEGER DEFAULT 160,
  social_insurance_enrolled BOOLEAN DEFAULT false,
  paid_leave_days INTEGER DEFAULT 0,
  invitation_token UUID UNIQUE,
  invitation_expires_at TIMESTAMP WITH TIME ZONE,
  qr_code_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE
);
```

**ENUMの定義**:
```sql
CREATE TYPE employee_role AS ENUM ('employee', 'manager', 'admin', 'system_admin');
CREATE TYPE employee_status AS ENUM ('active', 'inactive', 'invited');
```

#### positions（ポジション）
```sql
CREATE TABLE positions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  description TEXT,
  hourly_wage DECIMAL(8,0),
  color VARCHAR(7) DEFAULT '#6B7280',
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 3. シフト管理テーブル

#### shift_templates（シフトテンプレート）
```sql
CREATE TABLE shift_templates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  template_data JSONB NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_by UUID NOT NULL REFERENCES employees(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### shift_periods（シフト期間）
```sql
CREATE TABLE shift_periods (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  status shift_period_status DEFAULT 'draft',
  submission_deadline TIMESTAMP WITH TIME ZONE,
  created_by UUID NOT NULL REFERENCES employees(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TYPE shift_period_status AS ENUM ('draft', 'collecting', 'generating', 'published', 'finalized');
```

#### shift_requests（シフト希望）
```sql
CREATE TABLE shift_requests (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
  shift_period_id UUID NOT NULL REFERENCES shift_periods(id) ON DELETE CASCADE,
  request_data JSONB NOT NULL,
  status shift_request_status DEFAULT 'submitted',
  submitted_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TYPE shift_request_status AS ENUM ('draft', 'submitted', 'processed');
```

**request_dataサンプル**:
```json
{
  "preferences": [
    {
      "date": "2025-02-01",
      "available": true,
      "preferred_start": "09:00",
      "preferred_end": "18:00",
      "priority": "high"
    },
    {
      "date": "2025-02-02",
      "available": false,
      "reason": "個人的な用事"
    }
  ]
}
```

#### shifts（確定シフト）
```sql
CREATE TABLE shifts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  shift_period_id UUID REFERENCES shift_periods(id) ON DELETE SET NULL,
  position_id UUID REFERENCES positions(id),
  date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  break_start_time TIME,
  break_end_time TIME,
  hourly_wage DECIMAL(8,0),
  status shift_status DEFAULT 'scheduled',
  notes TEXT,
  created_by UUID REFERENCES employees(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TYPE shift_status AS ENUM ('scheduled', 'confirmed', 'cancelled', 'completed');
```

### 4. 勤怠管理テーブル

#### attendance_records（勤怠記録）
```sql
CREATE TABLE attendance_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  employee_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  shift_id UUID REFERENCES shifts(id) ON DELETE SET NULL,
  date DATE NOT NULL,
  clock_in_time TIMESTAMP WITH TIME ZONE,
  clock_out_time TIMESTAMP WITH TIME ZONE,
  clock_in_location POINT,
  clock_out_location POINT,
  break_start_time TIMESTAMP WITH TIME ZONE,
  break_end_time TIMESTAMP WITH TIME ZONE,
  total_break_minutes INTEGER DEFAULT 0,
  total_work_minutes INTEGER,
  overtime_minutes INTEGER DEFAULT 0,
  location_verified BOOLEAN DEFAULT false,
  status attendance_status DEFAULT 'in_progress',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TYPE attendance_status AS ENUM ('scheduled', 'in_progress', 'completed', 'absent');
```

#### attendance_edits（勤怠修正履歴）
```sql
CREATE TABLE attendance_edits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  attendance_record_id UUID NOT NULL REFERENCES attendance_records(id) ON DELETE CASCADE,
  edited_by UUID NOT NULL REFERENCES employees(id),
  edit_reason TEXT NOT NULL,
  old_values JSONB,
  new_values JSONB,
  approved_by UUID REFERENCES employees(id),
  approved_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 5. AI・通知管理テーブル

#### ai_shift_generations（AIシフト生成履歴）
```sql
CREATE TABLE ai_shift_generations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  shift_period_id UUID NOT NULL REFERENCES shift_periods(id) ON DELETE CASCADE,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  generation_input JSONB NOT NULL,
  generation_output JSONB,
  ai_model VARCHAR(50) DEFAULT 'gemini-pro',
  status ai_generation_status DEFAULT 'pending',
  error_message TEXT,
  created_by UUID NOT NULL REFERENCES employees(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP WITH TIME ZONE
);
```

```sql
CREATE TYPE ai_generation_status AS ENUM ('pending', 'processing', 'completed', 'failed');
```

#### notifications（通知）
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  recipient_id UUID NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
  sender_id UUID REFERENCES employees(id),
  title VARCHAR(200) NOT NULL,
  message TEXT NOT NULL,
  type notification_type NOT NULL,
  data JSONB,
  read_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TYPE notification_type AS ENUM ('shift_assigned', 'shift_changed', 'shift_reminder', 'attendance_alert', 'system');
```

### 6. 支払い・請求管理テーブル

#### billing_plans（料金プラン）
```sql
CREATE TABLE billing_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  price_per_employee DECIMAL(8,0) NOT NULL,
  max_employees INTEGER,
  features JSONB,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### store_subscriptions（店舗契約）
```sql
CREATE TABLE store_subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  billing_plan_id UUID NOT NULL REFERENCES billing_plans(id),
  stripe_customer_id VARCHAR(255),
  stripe_subscription_id VARCHAR(255),
  status subscription_status DEFAULT 'active',
  current_period_start TIMESTAMP WITH TIME ZONE,
  current_period_end TIMESTAMP WITH TIME ZONE,
  trial_end TIMESTAMP WITH TIME ZONE,
  employee_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

```sql
CREATE TYPE subscription_status AS ENUM ('active', 'trialing', 'past_due', 'canceled', 'unpaid');
```

## インデックス設計

```sql
-- パフォーマンス向上のためのインデックス
CREATE INDEX idx_employees_store_id ON employees(store_id);
CREATE INDEX idx_employees_user_id ON employees(user_id);
CREATE INDEX idx_employees_status ON employees(status);
CREATE INDEX idx_shifts_employee_date ON shifts(employee_id, date);
CREATE INDEX idx_shifts_store_date ON shifts(store_id, date);
CREATE INDEX idx_attendance_employee_date ON attendance_records(employee_id, date);
CREATE INDEX idx_attendance_store_date ON attendance_records(store_id, date);
CREATE INDEX idx_notifications_recipient_read ON notifications(recipient_id, read_at);

-- 地理的検索用のインデックス
CREATE INDEX idx_stores_location ON stores USING GIST(ll_to_earth(latitude, longitude));
CREATE INDEX idx_attendance_clock_in_location ON attendance_records USING GIST(clock_in_location);
```

## Row Level Security (RLS) ポリシー

```sql
-- stores テーブル
ALTER TABLE stores ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Store access for employees" ON stores
  FOR ALL TO authenticated
  USING (id IN (
    SELECT store_id FROM employees 
    WHERE user_id = auth.uid() AND status = 'active'
  ));

-- employees テーブル
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Employee access" ON employees
  FOR ALL TO authenticated
  USING (
    user_id = auth.uid() OR 
    store_id IN (
      SELECT store_id FROM employees 
      WHERE user_id = auth.uid() AND role IN ('admin', 'manager')
    )
  );

-- attendance_records テーブル
ALTER TABLE attendance_records ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Attendance access" ON attendance_records
  FOR ALL TO authenticated
  USING (
    employee_id IN (
      SELECT id FROM employees WHERE user_id = auth.uid()
    ) OR
    store_id IN (
      SELECT store_id FROM employees 
      WHERE user_id = auth.uid() AND role IN ('admin', 'manager')
    )
  );
```

## トリガー関数

```sql
-- updated_at自動更新
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ language 'plpgsql';

-- 各テーブルにトリガーを設定
CREATE TRIGGER update_stores_updated_at BEFORE UPDATE ON stores 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_employees_updated_at BEFORE UPDATE ON employees 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_shifts_updated_at BEFORE UPDATE ON shifts 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_attendance_updated_at BEFORE UPDATE ON attendance_records 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## データ整合性制約

```sql
-- 営業時間の制約
ALTER TABLE shifts ADD CONSTRAINT check_shift_times 
  CHECK (start_time < end_time);

-- 勤怠時間の制約
ALTER TABLE attendance_records ADD CONSTRAINT check_attendance_times 
  CHECK (clock_in_time < clock_out_time OR clock_out_time IS NULL);

-- 月次労働時間の制約
ALTER TABLE employees ADD CONSTRAINT check_monthly_limit 
  CHECK (monthly_limit_hours > 0 AND monthly_limit_hours <= 300);
```

## データマイグレーション戦略

### 初期データセットアップ
1. **料金プラン**の設定
2. **システム管理者**アカウントの作成
3. **デフォルトポジション**の作成
4. **サンプル店舗**の設定（開発環境）

### データバックアップ戦略
- **日次**: 全テーブルの自動バックアップ
- **週次**: 構造定義のバックアップ
- **月次**: アーカイブ用バックアップ

## パフォーマンス最適化

### クエリ最適化
- 日付範囲検索での複合インデックス活用
- JSON型フィールドでのGINインデックス利用
- パーティショニング（月次）の検討

### キャッシュ戦略
- 店舗設定: Redis 1時間キャッシュ
- 従業員リスト: Redis 30分キャッシュ  
- シフト情報: Redis 15分キャッシュ

## 関連ドキュメント
- 03_画面遷移_情報設計書.md
- 05_API仕様書.md
- 06_非機能要件定義書.md