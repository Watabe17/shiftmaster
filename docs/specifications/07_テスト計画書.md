# 07_テスト計画書.md

## 概要
本文書では、ShiftMasterの包括的なテスト戦略と計画について詳細に定義します。品質保証のための各種テスト手法、テストケース、実行計画を明確化し、安定したシステムリリースを実現します。

## テスト戦略

### テストピラミッド
```typescript
interface TestPyramid {
  unit_tests: {
    coverage_target: '80%以上';
    execution_frequency: '全コミット時';
    tools: ['Jest', 'Vitest', '@testing-library/react'];
    scope: '個別関数・コンポーネント';
  };
  integration_tests: {
    coverage_target: '主要API・DB連携';
    execution_frequency: 'プルリクエスト時';
    tools: ['Supertest', 'Prisma Client'];
    scope: 'API・データベース・外部サービス連携';
  };
  e2e_tests: {
    coverage_target: '主要ユーザーフロー';
    execution_frequency: 'デプロイ前';
    tools: ['Playwright', 'Cypress'];
    scope: 'ブラウザベース完全フロー';
  };
}
```

### テスト環境
| 環境 | 用途 | データ | 自動化レベル |
|------|------|--------|-------------|
| Local | 開発・単体テスト | モックデータ | 完全自動 |
| Development | 統合テスト | シードデータ | 完全自動 |
| Staging | E2Eテスト・UAT | 本番類似データ | 半自動 |
| Production | 本番監視テスト | 本番データ | 監視のみ |

## テスト分類と詳細

### 1. 単体テスト（Unit Tests）

#### 1.1 フロントエンド単体テスト
```typescript
// テスト対象コンポーネント例
describe('ClockInButton', () => {
  it('位置情報取得成功時に打刻ボタンが有効になる', async () => {
    const mockGeolocation = {
      getCurrentPosition: jest.fn((success) => 
        success({ coords: { latitude: 35.6762, longitude: 139.6503 } })
      )
    };
    global.navigator.geolocation = mockGeolocation;
    
    render(<ClockInButton />);
    await waitFor(() => {
      expect(screen.getByRole('button', { name: '出勤' })).toBeEnabled();
    });
  });
  
  it('位置情報取得失敗時にエラーメッセージを表示', async () => {
    const mockGeolocation = {
      getCurrentPosition: jest.fn((success, error) => 
        error({ code: 1, message: 'Permission denied' })
      )
    };
    global.navigator.geolocation = mockGeolocation;
    
    render(<ClockInButton />);
    await waitFor(() => {
      expect(screen.getByText('位置情報の取得に失敗しました')).toBeInTheDocument();
    });
  });
});
```

#### 1.2 バックエンド単体テスト
```typescript
// API関数テスト例
describe('calculateWorkingHours', () => {
  it('標準勤務時間（8時間）の計算が正確', () => {
    const clockIn = new Date('2025-02-10T09:00:00Z');
    const clockOut = new Date('2025-02-10T18:00:00Z');
    const breakMinutes = 60;
    
    const result = calculateWorkingHours(clockIn, clockOut, breakMinutes);
    
    expect(result.totalMinutes).toBe(480); // 8時間
    expect(result.overtime).toBe(0);
  });
  
  it('残業時間の計算が正確', () => {
    const clockIn = new Date('2025-02-10T09:00:00Z');
    const clockOut = new Date('2025-02-10T19:30:00Z');
    const breakMinutes = 60;
    
    const result = calculateWorkingHours(clockIn, clockOut, breakMinutes);
    
    expect(result.totalMinutes).toBe(570); // 9.5時間
    expect(result.overtime).toBe(90); // 1.5時間残業
  });
});
```

#### 1.3 ユーティリティ関数テスト
```typescript
describe('位置情報関連ユーティリティ', () => {
  describe('calculateDistance', () => {
    it('東京駅と渋谷駅間の距離計算', () => {
      const tokyo = { lat: 35.6812, lng: 139.7671 };
      const shibuya = { lat: 35.6580, lng: 139.7016 };
      
      const distance = calculateDistance(tokyo, shibuya);
      
      expect(distance).toBeCloseTo(6500, -2); // 約6.5km（100m誤差許容）
    });
  });
  
  describe('isWithinRadius', () => {
    it('許可範囲内での位置認証成功', () => {
      const storeLocation = { lat: 35.6812, lng: 139.7671 };
      const userLocation = { lat: 35.6815, lng: 139.7675 };
      const radius = 50; // 50m
      
      expect(isWithinRadius(userLocation, storeLocation, radius)).toBe(true);
    });
    
    it('許可範囲外での位置認証失敗', () => {
      const storeLocation = { lat: 35.6812, lng: 139.7671 };
      const userLocation = { lat: 35.6900, lng: 139.7900 };
      const radius = 50; // 50m
      
      expect(isWithinRadius(userLocation, storeLocation, radius)).toBe(false);
    });
  });
});
```

### 2. 統合テスト（Integration Tests）

#### 2.1 API統合テスト
```typescript
describe('従業員管理API', () => {
  beforeEach(async () => {
    await setupTestDatabase();
    await seedTestData();
  });
  
  describe('POST /api/v1/employees', () => {
    it('管理者による従業員招待が成功', async () => {
      const adminToken = await getAdminToken();
      const inviteData = {
        full_name: 'テスト太郎',
        email: 'test@example.com',
        position_id: 'position-1',
        hourly_wage: 1000
      };
      
      const response = await request(app)
        .post('/api/v1/employees')
        .set('Authorization', `Bearer ${adminToken}`)
        .send(inviteData)
        .expect(201);
      
      expect(response.body.data.employee.full_name).toBe('テスト太郎');
      expect(response.body.data.invitation_url).toMatch(/\/invite\//);
      expect(response.body.data.qr_code_url).toBeTruthy();
    });
    
    it('一般従業員による招待は権限エラー', async () => {
      const employeeToken = await getEmployeeToken();
      const inviteData = {
        full_name: 'テスト太郎',
        position_id: 'position-1'
      };
      
      await request(app)
        .post('/api/v1/employees')
        .set('Authorization', `Bearer ${employeeToken}`)
        .send(inviteData)
        .expect(403);
    });
  });
});
```

#### 2.2 データベース統合テスト
```typescript
describe('勤怠記録データベース操作', () => {
  it('打刻から勤怠記録作成まで一連の流れ', async () => {
    // 出勤打刻
    const clockInRecord = await AttendanceService.clockIn({
      employee_id: 'emp-1',
      store_id: 'store-1',
      latitude: 35.6812,
      longitude: 139.7671
    });
    
    expect(clockInRecord.clock_in_time).toBeTruthy();
    expect(clockInRecord.location_verified).toBe(true);
    
    // 退勤打刻
    const clockOutRecord = await AttendanceService.clockOut({
      attendance_id: clockInRecord.id,
      latitude: 35.6812,
      longitude: 139.7671
    });
    
    expect(clockOutRecord.clock_out_time).toBeTruthy();
    expect(clockOutRecord.total_work_minutes).toBeGreaterThan(0);
  });
});
```

### 3. E2Eテスト（End-to-End Tests）

#### 3.1 主要ユーザーフローテスト
```typescript
// Playwright E2Eテスト例
test.describe('従業員の1日の勤怠フロー', () => {
  test('出勤から退勤までの完全フロー', async ({ page, context }) => {
    // 位置情報許可をモック
    await context.grantPermissions(['geolocation']);
    await context.setGeolocation({ latitude: 35.6812, longitude: 139.7671 });
    
    // 1. ログイン
    await page.goto('/invite/test-token');
    await page.fill('[data-testid=password]', 'TestPassword123!');
    await page.fill('[data-testid=full-name]', 'テスト太郎');
    await page.click('[data-testid=signin-button]');
    
    // 2. ダッシュボード確認
    await expect(page.locator('[data-testid=employee-name]')).toContainText('テスト太郎');
    
    // 3. 出勤打刻
    await page.click('[data-testid=clock-in-button]');
    await expect(page.locator('[data-testid=success-message]')).toContainText('出勤しました');
    
    // 4. 勤怠状況確認
    await page.click('[data-testid=attendance-tab]');
    await expect(page.locator('[data-testid=current-status]')).toContainText('勤務中');
    
    // 5. 退勤打刻
    await page.click('[data-testid=clock-out-button]');
    await expect(page.locator('[data-testid=success-message]')).toContainText('お疲れさまでした');
  });
});
```

#### 3.2 管理者機能E2Eテスト
```typescript
test.describe('管理者によるシフト管理', () => {
  test('AIシフト生成から確定まで', async ({ page }) => {
    await loginAsAdmin(page);
    
    // 1. シフト期間作成
    await page.goto('/admin/shifts');
    await page.click('[data-testid=create-period-button]');
    await page.fill('[data-testid=period-name]', '2025年3月シフト');
    await page.fill('[data-testid=start-date]', '2025-03-01');
    await page.fill('[data-testid=end-date]', '2025-03-31');
    await page.click('[data-testid=save-button]');
    
    // 2. シフト希望収集確認
    await expect(page.locator('[data-testid=requests-count]')).toContainText('5件');
    
    // 3. AIシフト生成
    await page.click('[data-testid=generate-ai-shift]');
    await page.waitForSelector('[data-testid=generation-complete]', { timeout: 60000 });
    
    // 4. 生成結果確認・調整
    await expect(page.locator('[data-testid=coverage-rate]')).toContainText('95%');
    
    // 5. シフト確定・公開
    await page.click('[data-testid=publish-shift]');
    await expect(page.locator('[data-testid=status]')).toContainText('公開済み');
  });
});
```

### 4. パフォーマンステスト

#### 4.1 負荷テスト（Load Testing）
```javascript
// k6負荷テストスクリプト
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '5m', target: 100 }, // 5分で100ユーザーまで増加
    { duration: '10m', target: 100 }, // 10分間100ユーザー維持
    { duration: '5m', target: 200 }, // 5分で200ユーザーまで増加
    { duration: '10m', target: 200 }, // 10分間200ユーザー維持
    { duration: '5m', target: 0 }, // 5分で0まで減少
  ],
  thresholds: {
    http_req_duration: ['p(95)<2000'], // 95%のリクエストが2秒以内
    http_req_failed: ['rate<0.01'], // エラー率1%未満
  },
};

export default function() {
  // ログイン
  let loginResponse = http.post('https://api.example.com/auth/signin', {
    email: 'test@example.com',
    password: 'password123'
  });
  
  check(loginResponse, {
    'ログイン成功': (r) => r.status === 200,
    'レスポンス時間OK': (r) => r.timings.duration < 1000,
  });
  
  let token = loginResponse.json('access_token');
  
  // 打刻API
  let clockInResponse = http.post('https://api.example.com/attendance/clock-in', 
    { latitude: 35.6812, longitude: 139.7671 },
    { headers: { Authorization: `Bearer ${token}` } }
  );
  
  check(clockInResponse, {
    '打刻成功': (r) => r.status === 200,
    'レスポンス時間OK': (r) => r.timings.duration < 2000,
  });
  
  sleep(1);
}
```

#### 4.2 ストレステスト
```javascript
// 限界値テスト
export let options = {
  stages: [
    { duration: '2m', target: 500 },
    { duration: '5m', target: 500 },
    { duration: '2m', target: 1000 },
    { duration: '5m', target: 1000 },
    { duration: '2m', target: 1500 },
    { duration: '5m', target: 1500 },
    { duration: '10m', target: 0 },
  ],
};
```

### 5. セキュリティテスト

#### 5.1 認証・認可テスト
```typescript
describe('セキュリティテスト', () => {
  describe('認証', () => {
    it('無効なトークンでのアクセス拒否', async () => {
      await request(app)
        .get('/api/v1/employees')
        .set('Authorization', 'Bearer invalid-token')
        .expect(401);
    });
    
    it('期限切れトークンでのアクセス拒否', async () => {
      const expiredToken = generateExpiredToken();
      await request(app)
        .get('/api/v1/employees')
        .set('Authorization', `Bearer ${expiredToken}`)
        .expect(401);
    });
  });
  
  describe('認可', () => {
    it('従業員が他店舗データにアクセス不可', async () => {
      const employeeToken = await getEmployeeToken('store-1');
      await request(app)
        .get('/api/v1/stores/store-2/employees')
        .set('Authorization', `Bearer ${employeeToken}`)
        .expect(403);
    });
  });
});
```

#### 5.2 入力検証テスト
```typescript
describe('入力検証', () => {
  it('SQLインジェクション対策', async () => {
    const maliciousInput = "'; DROP TABLE employees; --";
    await request(app)
      .post('/api/v1/employees')
      .send({ full_name: maliciousInput })
      .expect(400);
  });
  
  it('XSS対策', async () => {
    const xssPayload = '<script>alert("xss")</script>';
    const response = await request(app)
      .post('/api/v1/employees')
      .send({ full_name: xssPayload });
    
    expect(response.body.data.full_name).not.toContain('<script>');
  });
});
```

### 6. モバイルテスト

#### 6.1 レスポンシブテスト
```typescript
test.describe('モバイル対応', () => {
  test('スマートフォンでの打刻操作', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 }); // iPhone SE
    await page.goto('/');
    
    // タッチ操作テスト
    await page.tap('[data-testid=clock-in-button]');
    await expect(page.locator('[data-testid=success-message]')).toBeVisible();
  });
  
  test('タブレットでのシフト確認', async ({ page }) => {
    await page.setViewportSize({ width: 768, height: 1024 }); // iPad
    await page.goto('/shifts');
    
    // スワイプ操作テスト
    const calendar = page.locator('[data-testid=shift-calendar]');
    await calendar.hover();
    await page.mouse.down();
    await page.mouse.move(100, 0);
    await page.mouse.up();
  });
});
```

### 7. アクセシビリティテスト

#### 7.1 WCAG準拠テスト
```typescript
import { injectAxe, checkA11y } from 'axe-playwright';

test.describe('アクセシビリティ', () => {
  test('メインページのWCAG AA準拠', async ({ page }) => {
    await page.goto('/');
    await injectAxe(page);
    await checkA11y(page, null, {
      detailedReport: true,
      detailedReportOptions: { html: true },
    });
  });
  
  test('キーボードナビゲーション', async ({ page }) => {
    await page.goto('/');
    
    // Tabキーでナビゲーション
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'menu-button');
    
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'clock-in-button');
  });
});
```

## テスト実行計画

### CI/CDパイプライン統合
```yaml
# GitHub Actions例
name: Test Pipeline
on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run test:unit
      - run: npm run test:coverage

  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
    steps:
      - uses: actions/checkout@v3
      - run: npm run test:integration

  e2e-tests:
    needs: integration-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: microsoft/playwright-github-action@v1
      - run: npm run test:e2e

  performance-tests:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm run test:performance
```

### テストデータ管理
```typescript
interface TestDataStrategy {
  unit_tests: {
    data_source: 'ファクトリー関数・モック';
    isolation: '完全独立';
    cleanup: '自動';
  };
  integration_tests: {
    data_source: 'シードデータ';
    isolation: 'トランザクション分離';
    cleanup: 'ロールバック';
  };
  e2e_tests: {
    data_source: '専用テストDB';
    isolation: 'テスト環境分離';
    cleanup: '定期リセット';
  };
}
```

## 品質メトリクス

### 品質ゲート
```typescript
interface QualityGates {
  code_coverage: {
    unit_tests: '>= 80%';
    integration_tests: '>= 60%';
    overall: '>= 70%';
  };
  test_success_rate: {
    target: '>= 98%';
    blocking_threshold: '< 95%';
  };
  performance: {
    response_time_p95: '< 2 seconds';
    error_rate: '< 0.1%';
  };
  security: {
    vulnerability_scan: 'no high/critical';
    dependency_check: 'no known vulnerabilities';
  };
}
```

### 継続的品質改善
- **週次レビュー**: テスト結果・カバレッジ分析
- **月次改善**: フレイキーテスト修正・テストケース追加
- **四半期評価**: テスト戦略見直し・ツール評価

## 関連ドキュメント
- 06_非機能要件定義書.md
- 08_運用・保守マニュアル.md
- 02_ユーザーストーリー_受け入れ基準.md