# 08_運用・保守マニュアル.md

## 概要
本文書では、ShiftMasterの本番環境での運用・保守に関する手順、監視、障害対応、メンテナンス計画について詳細に定義します。安定したサービス提供を継続するための包括的な運用ガイドです。

## 運用体制

### 運用チーム構成
```typescript
interface OperationTeam {
  system_admin: {
    role: 'システム管理者';
    responsibilities: [
      'インフラ監視・管理',
      'セキュリティ対策',
      'バックアップ・災害対策',
      'パフォーマンス最適化'
    ];
    on_call: '24時間365日';
  };
  application_admin: {
    role: 'アプリケーション管理者';
    responsibilities: [
      'アプリケーション監視',
      'ユーザーサポート',
      'データ整合性チェック',
      '機能追加・修正の検証'
    ];
    working_hours: '平日 9:00-18:00';
  };
  business_admin: {
    role: 'ビジネス管理者';
    responsibilities: [
      '顧客サポート',
      'SLA管理',
      'ビジネス要件調整',
      'ユーザートレーニング'
    ];
    working_hours: '平日 9:00-18:00';
  };
}
```

### エスカレーション体制
| レベル | 対応者 | 対応時間 | 連絡方法 |
|--------|--------|----------|----------|
| L1 | 監視システム | 即座 | 自動アラート |
| L2 | システム管理者 | 15分以内 | SMS + メール |
| L3 | 開発チーム | 1時間以内 | 電話 + チャット |
| L4 | 経営陣 | 4時間以内 | 直接報告 |

## 監視・アラート

### システム監視項目
```typescript
interface MonitoringMetrics {
  infrastructure: {
    cpu_usage: {
      warning: '70%';
      critical: '90%';
      check_interval: '1 minute';
    };
    memory_usage: {
      warning: '80%';
      critical: '95%';
      check_interval: '1 minute';
    };
    disk_usage: {
      warning: '80%';
      critical: '90%';
      check_interval: '5 minutes';
    };
    network_latency: {
      warning: '100ms';
      critical: '500ms';
      check_interval: '30 seconds';
    };
  };
  application: {
    response_time: {
      warning: '2 seconds';
      critical: '5 seconds';
      check_interval: '30 seconds';
    };
    error_rate: {
      warning: '1%';
      critical: '5%';
      check_interval: '1 minute';
    };
    availability: {
      warning: '99.5%';
      critical: '99%';
      check_interval: '1 minute';
    };
    active_users: {
      info_threshold: '100 concurrent';
      warning: '500 concurrent';
      critical: '1000 concurrent';
    };
  };
  business: {
    clock_in_success_rate: {
      warning: '95%';
      critical: '90%';
      check_interval: '5 minutes';
    };
    ai_generation_success_rate: {
      warning: '90%';
      critical: '80%';
      check_interval: '10 minutes';
    };
    data_sync_delay: {
      warning: '5 minutes';
      critical: '15 minutes';
      check_interval: '2 minutes';
    };
  };
}
```

### アラート通知設定
```typescript
interface AlertConfiguration {
  notification_channels: {
    critical: ['SMS', 'Phone', 'Email', 'Slack'];
    warning: ['Email', 'Slack'];
    info: ['Slack'];
  };
  escalation_rules: {
    no_response_time: '15 minutes';
    auto_escalation: true;
    max_escalation_level: 4;
  };
  quiet_hours: {
    enabled: false; // 24時間監視のため無効
    schedule: 'N/A';
  };
}
```

## 日常運用手順

### 1. 日次運用チェックリスト

#### 午前チェック（9:00）
```markdown
□ システム稼働状況確認
  - Vercel デプロイメント状況
  - Supabase データベース接続確認
  - CDN キャッシュ状況確認

□ 前日の運用ログ確認
  - エラーログ分析
  - パフォーマンスメトリクス確認
  - セキュリティインシデント確認

□ バックアップ状況確認
  - データベースバックアップ完了確認
  - ファイルバックアップ確認
  - バックアップの整合性チェック

□ ユーザーサポート確認
  - 新規問い合わせ確認
  - 未解決チケット確認
  - SLA達成状況確認
```

#### 夕方チェック（17:00）
```markdown
□ 当日の業務データ確認
  - 打刻データ整合性チェック
  - シフトデータ同期確認
  - 勤怠計算の正確性確認

□ 翌日の準備確認
  - シフトスケジュール配信確認
  - 通知送信状況確認
  - システムリソース余裕確認

□ セキュリティ状況確認
  - 不正アクセス試行ログ確認
  - 認証失敗パターン分析
  - セキュリティアップデート確認
```

### 2. 週次運用作業

#### 毎週月曜日
```markdown
□ 週次レポート作成
  - 稼働率レポート
  - パフォーマンスサマリー
  - インシデント分析
  - ユーザー満足度集計

□ 容量計画確認
  - データベース使用量推移
  - ストレージ使用量確認
  - 帯域使用量分析
  - スケーリング判断

□ セキュリティ監査
  - アクセスログ分析
  - 権限設定レビュー
  - 脆弱性スキャン実行
```

### 3. 月次運用作業

#### 毎月第1営業日
```markdown
□ 月次システムメンテナンス
  - データベース最適化（VACUUM, REINDEX）
  - ログローテーション
  - 古いデータのアーカイブ
  - システムリソースクリーンアップ

□ 月次レポート作成
  - SLA達成率レポート
  - コスト分析レポート
  - 利用統計レポート
  - 改善提案まとめ

□ バックアップ検証
  - フルリストア テスト
  - 災害復旧手順確認
  - RPO/RTO 達成確認
```

## 障害対応手順

### 障害分類と初期対応

#### Critical障害（サービス全停止）
```typescript
interface CriticalIncidentResponse {
  detection: {
    auto_monitoring: 'システム監視による自動検知';
    manual_report: 'ユーザーからの障害報告';
    health_check: 'ヘルスチェック失敗';
  };
  
  immediate_actions: [
    '1. インシデント宣言（5分以内）',
    '2. 関係者への緊急連絡',
    '3. 障害状況の初期調査',
    '4. 顧客への暫定報告（30分以内）',
    '5. 復旧作業開始'
  ];
  
  investigation_steps: [
    '1. システムログ確認',
    '2. データベース接続確認',
    '3. 外部サービス状況確認',
    '4. 最近のデプロイ履歴確認',
    '5. リソース使用量確認'
  ];
}
```

#### High障害（主要機能停止）
```markdown
## High障害対応手順

### 1. 初期対応（15分以内）
- インシデントチケット作成
- 影響範囲の特定
- 暫定回避策の検討

### 2. 調査・対応（1時間以内）
- 根本原因の特定
- 修正方法の決定
- テスト環境での修正確認
- 本番環境への適用

### 3. 事後対応
- 復旧確認
- 顧客への報告
- 事後分析レポート作成
```

### 障害対応プレイブック

#### データベース接続障害
```bash
# 1. 接続状況確認
psql -h <db_host> -U <username> -d <database> -c "SELECT 1;"

# 2. コネクションプール確認
# Supabase Dashboard でコネクション数確認

# 3. プロセス確認
SELECT pid, usename, application_name, state, query_start, query 
FROM pg_stat_activity 
WHERE state != 'idle' 
ORDER BY query_start;

# 4. 長時間実行クエリの終了
SELECT pg_terminate_backend(pid) FROM pg_stat_activity 
WHERE state != 'idle' AND query_start < NOW() - INTERVAL '5 minutes';
```

#### アプリケーション高負荷対応
```bash
# 1. リソース使用量確認
# Vercel ダッシュボードでメトリクス確認

# 2. エラーログ確認
# Sentry でエラー急増の確認

# 3. 緊急スケーリング
# Vercel での自動スケーリング確認

# 4. キャッシュクリア（必要に応じて）
# Redis キャッシュのクリア実行
```

#### セキュリティインシデント対応
```markdown
## セキュリティインシデント対応

### 1. 封じ込め（即座）
- 不正アクセス元IPの遮断
- 影響を受けたアカウントの一時停止
- 関連システムの隔離

### 2. 調査（1時間以内）
- アクセスログの詳細分析
- 影響範囲の特定
- データ漏洩の有無確認

### 3. 復旧・強化
- セキュリティパッチ適用
- パスワードリセット要求
- 監視ルール強化

### 4. 報告
- 法的要件に基づく報告
- 顧客への透明な情報提供
- 再発防止策の策定
```

## バックアップ・復旧手順

### バックアップ戦略
```typescript
interface BackupStrategy {
  database: {
    full_backup: {
      frequency: '日次 2:00 AM JST';
      retention: '30日間';
      storage: 'Supabase + AWS S3';
      encryption: 'AES-256';
    };
    incremental_backup: {
      frequency: '6時間毎';
      retention: '7日間';
      method: 'WAL-E continuous archiving';
    };
    point_in_time_recovery: {
      granularity: '1秒';
      retention: '7日間';
    };
  };
  
  application_data: {
    file_uploads: {
      method: 'Supabase Storage replication';
      frequency: 'リアルタイム';
      geo_redundancy: true;
    };
    configuration: {
      method: 'Git repository';
      frequency: '変更時';
      versioning: true;
    };
  };
}
```

### 復旧手順

#### データベース復旧
```bash
# 1. Point-in-Time Recovery
# Supabase Dashboard から復旧ポイントを選択

# 2. バックアップからの復旧
# 日次バックアップからの完全復旧

# 3. 復旧確認
psql -h <restored_db> -c "
  SELECT COUNT(*) FROM stores;
  SELECT COUNT(*) FROM employees;
  SELECT COUNT(*) FROM attendance_records;
"

# 4. アプリケーション接続先変更
# 環境変数の更新とアプリケーション再デプロイ
```

#### アプリケーション復旧
```bash
# 1. 前バージョンへのロールバック
vercel rollback <deployment_id>

# 2. 設定ファイル復旧
git checkout <previous_commit> -- config/

# 3. 依存関係の復旧
npm ci

# 4. 動作確認
npm run test:smoke
```

## 定期メンテナンス

### システムメンテナンス計画
```typescript
interface MaintenanceSchedule {
  daily: {
    time: '2:00-3:00 AM JST';
    activities: [
      'データベースバックアップ',
      'ログローテーション',
      'キャッシュクリーンアップ',
      'ヘルスチェック'
    ];
    downtime: '0分（無停止）';
  };
  
  weekly: {
    time: '日曜日 1:00-2:00 AM JST';
    activities: [
      'データベース統計更新',
      'セキュリティスキャン',
      'パフォーマンス分析',
      'ログ分析'
    ];
    downtime: '0分（無停止）';
  };
  
  monthly: {
    time: '第1日曜日 0:00-2:00 AM JST';
    activities: [
      'データベース最適化',
      'セキュリティパッチ適用',
      '依存関係更新',
      '災害復旧テスト'
    ];
    downtime: '最大30分';
  };
  
  quarterly: {
    time: '事前調整';
    activities: [
      'メジャーバージョンアップデート',
      '証明書更新',
      'セキュリティ監査',
      'パフォーマンス最適化'
    ];
    downtime: '最大2時間';
  };
}
```

### メンテナンス実行手順

#### 月次メンテナンス
```markdown
## 月次メンテナンス手順

### 事前準備（1週間前）
□ メンテナンス通知の配信
□ バックアップの完全性確認
□ ロールバック手順の確認
□ メンテナンス用スクリプトの準備

### メンテナンス当日
□ 開始30分前の最終確認
□ ユーザー向けメンテナンス通知表示
□ トラフィック監視開始

### メンテナンス実行
1. データベース最適化
```sql
-- 統計情報更新
ANALYZE;

-- インデックスの再構築
REINDEX DATABASE shiftmaster;

-- 不要データの削除
DELETE FROM notifications WHERE created_at < NOW() - INTERVAL '3 months';
DELETE FROM audit_logs WHERE created_at < NOW() - INTERVAL '1 year';
```

2. セキュリティアップデート
```bash
# 依存関係の更新確認
npm audit
npm update

# セキュリティパッチ適用
# Vercel/Supabase の自動更新確認
```

3. パフォーマンス確認
```bash
# レスポンス時間測定
curl -w "@curl-format.txt" -s -o /dev/null https://app.example.com/api/health

# データベースパフォーマンス確認
SELECT * FROM pg_stat_user_tables WHERE schemaname = 'public';
```

### 事後確認
□ 全機能の動作確認
□ パフォーマンスメトリクス確認
□ エラーログ確認
□ ユーザーからの問い合わせ確認
□ メンテナンス完了通知
```

## 容量管理・スケーリング

### 容量監視項目
```typescript
interface CapacityMonitoring {
  database: {
    storage_size: {
      current_usage: 'モニタリング';
      growth_rate: '月次計算';
      alert_threshold: '80%';
      scaling_plan: '事前拡張';
    };
    connection_pool: {
      max_connections: '100';
      current_usage: 'リアルタイム監視';
      alert_threshold: '80';
    };
  };
  
  application: {
    concurrent_users: {
      peak_capacity: '1000';
      current_peak: 'リアルタイム監視';
      scaling_trigger: '800';
    };
    memory_usage: {
      per_instance: '512MB';
      utilization: 'リアルタイム監視';
      scaling_trigger: '400MB';
    };
  };
  
  storage: {
    file_uploads: {
      total_size: 'Supabase Storage監視';
      growth_rate: '月次計算';
      cleanup_policy: '自動削除設定';
    };
  };
}
```

### スケーリング計画
```markdown
## スケーリング戦略

### 水平スケーリング
- **Vercel**: 自動スケーリング（並行実行数）
- **Supabase**: 読み取り専用レプリカ追加
- **CDN**: エッジキャッシュ拡張

### 垂直スケーリング  
- **データベース**: インスタンスサイズアップ
- **アプリケーション**: メモリ・CPU割り当て増加

### 予防的スケーリング
- **予測ベース**: 過去のトラフィックパターン分析
- **イベントベース**: 繁忙期の事前準備
- **アラートベース**: しきい値到達時の自動拡張
```

## セキュリティ運用

### セキュリティ監視
```typescript
interface SecurityMonitoring {
  access_monitoring: {
    failed_logins: {
      threshold: '5回/5分';
      action: 'アカウントロック';
      alert: '管理者通知';
    };
    suspicious_locations: {
      detection: 'IP地理位置分析';
      action: 'MFA要求';
      logging: '詳細ログ記録';
    };
    privilege_escalation: {
      monitoring: '権限変更の監視';
      approval: '管理者承認必須';
      audit: '監査ログ保存';
    };
  };
  
  data_protection: {
    encryption_status: {
      check: '日次確認';
      certificate_expiry: '30日前アラート';
      key_rotation: '90日周期';
    };
    backup_security: {
      encryption: 'バックアップ暗号化確認';
      access_control: 'アクセス権限監査';
      integrity: '整合性チェック';
    };
  };
}
```

### インシデント対応

#### セキュリティインシデント分類
| レベル | 定義 | 対応時間 | 対応者 |
|--------|------|----------|--------|
| Critical | データ漏洩・不正アクセス成功 | 15分以内 | セキュリティチーム |
| High | 攻撃の兆候・脆弱性発見 | 1時間以内 | システム管理者 |
| Medium | 異常なアクセスパターン | 4時間以内 | システム管理者 |
| Low | 軽微なセキュリティイベント | 24時間以内 | 日常運用チーム |

## ユーザーサポート

### サポート体制
```typescript
interface SupportStructure {
  first_level: {
    channel: ['チャット', 'メール', '電話'];
    response_time: '1時間以内';
    resolution_rate: '70%';
    escalation_criteria: '技術的問題・権限必要';
  };
  
  second_level: {
    channel: ['メール', '電話', 'リモートサポート'];
    response_time: '4時間以内';
    resolution_rate: '90%';
    escalation_criteria: 'システム障害・開発案件';
  };
  
  third_level: {
    channel: ['開発チーム直接対応'];
    response_time: '24時間以内';
    resolution_rate: '100%';
    scope: 'バグ修正・機能拡張';
  };
}
```

### よくある問い合わせと対応

#### 打刻関連
```markdown
## Q: 位置情報で打刻できない
**A: 対応手順**
1. GPS設定確認（ブラウザ・デバイス両方）
2. 店舗から50m以内にいるか確認
3. 店舗の位置設定確認（管理者向け）
4. 手動修正での一時対応（管理者権限）

## Q: 時間が正しく表示されない  
**A: 対応手順**
1. デバイスの時刻設定確認
2. タイムゾーン設定確認
3. ブラウザキャッシュクリア
4. サーバー時刻との同期確認
```

#### アカウント関連
```markdown
## Q: ログインできない
**A: 対応手順**
1. 招待メールの有効期限確認
2. パスワード要件の確認
3. アカウントロック状態確認
4. 新しい招待URLの発行

## Q: 権限がない
**A: 対応手順**  
1. ユーザーの役割確認
2. 店舗への紐付け確認
3. 権限設定の確認
4. 管理者による権限調整
```

## 性能最適化

### 継続的な性能改善
```typescript
interface PerformanceOptimization {
  database: {
    query_optimization: {
      slow_query_monitoring: 'pgAdmin insights';
      index_optimization: '月次レビュー';
      connection_pooling: 'Prisma設定最適化';
    };
    data_management: {
      archiving: '古いデータの定期アーカイブ';
      partitioning: 'テーブル分割の検討';
      compression: 'データ圧縮の適用';
    };
  };
  
  application: {
    caching: {
      redis_optimization: 'キャッシュ戦略見直し';
      cdn_configuration: 'CloudFront設定最適化';
      browser_caching: 'キャッシュヘッダー最適化';
    };
    code_optimization: {
      bundle_size: 'JavaScript最適化';
      image_optimization: 'Next.js Image最適化';
      lazy_loading: '遅延読み込み実装';
    };
  };
}
```

## ドキュメント管理

### 運用ドキュメント更新
```markdown
## 更新スケジュール

### 月次更新
- 運用手順書の見直し
- 障害対応事例の追加
- FAQ更新

### 四半期更新  
- システム構成図更新
- 容量計画見直し
- セキュリティポリシー更新

### 年次更新
- 運用体制見直し
- SLA見直し
- 災害復旧計画更新
```

## 関連ドキュメント
- 06_非機能要件定義書.md
- 07_テスト計画書.md
- 04_データモデル設計書.md
- 05_API仕様書.md

---

## 緊急連絡先

### 社内連絡先
- **システム管理者**: [24時間対応番号]
- **開発チームリーダー**: [連絡先]
- **経営陣**: [緊急時連絡先]

### 外部連絡先
- **Vercel サポート**: [サポートチケット]
- **Supabase サポート**: [サポートチケット]  
- **セキュリティベンダー**: [緊急連絡先]

---

*本マニュアルは運用開始時に最新化し、定期的に更新してください。*