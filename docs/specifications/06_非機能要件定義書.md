# 06_非機能要件定義書.md

## 概要
本文書では、ShiftMasterの非機能要件（性能、可用性、セキュリティ、運用性等）について詳細に定義します。システムの品質特性と技術的制約を明確化し、安定したサービス提供を実現します。

## 非機能要件の分類

### 1. 性能要件

#### 1.1 レスポンス性能
| 機能 | 目標値 | 限界値 | 測定条件 |
|------|--------|--------|----------|
| 画面表示 | 2秒以内 | 5秒以内 | 通常負荷時 |
| API応答 | 500ms以内 | 2秒以内 | 同時接続100ユーザー |
| 打刻処理 | 1秒以内 | 3秒以内 | GPS位置取得含む |
| AIシフト生成 | 30秒以内 | 2分以内 | 50名・1ヶ月分 |
| データエクスポート | 10秒以内 | 30秒以内 | 月次データ（CSV） |

#### 1.2 スループット性能
```typescript
interface PerformanceTargets {
  concurrent_users: {
    target: 500;
    peak: 1000;
  };
  api_requests_per_second: {
    target: 1000;
    peak: 2000;
  };
  database_connections: {
    max_pool_size: 20;
    timeout_seconds: 30;
  };
  file_upload: {
    max_size_mb: 10;
    concurrent_uploads: 50;
  };
}
```

#### 1.3 リソース使用量
- **CPU使用率**: 平常時70%以下、ピーク時90%以下
- **メモリ使用率**: 平常時80%以下、ピーク時95%以下
- **ディスク容量**: 予測成長率月5%、アラート閾値80%
- **ネットワーク帯域**: 平常時100Mbps、ピーク時500Mbps

### 2. 可用性要件

#### 2.1 稼働率
```typescript
interface AvailabilityTargets {
  overall_uptime: '99.9%'; // 年間ダウンタイム8.77時間以内
  planned_maintenance: {
    frequency: 'monthly';
    duration_max: '2 hours';
    notification_advance: '72 hours';
  };
  unplanned_downtime: {
    mttr_target: '30 minutes'; // 平均復旧時間
    mtbf_target: '720 hours'; // 平均故障間隔
  };
}
```

#### 2.2 障害対応
| 障害レベル | 復旧目標時間 | 通知タイミング | 対応体制 |
|-----------|-------------|---------------|----------|
| Critical | 15分以内 | 即座 | 24時間体制 |
| High | 1時間以内 | 30分以内 | 営業時間内 |
| Medium | 4時間以内 | 1時間以内 | 営業時間内 |
| Low | 24時間以内 | 4時間以内 | 次営業日 |

#### 2.3 災害対策・冗長化
```typescript
interface DisasterRecovery {
  backup_strategy: {
    database: {
      full_backup: 'daily at 2:00 AM JST';
      incremental: 'every 6 hours';
      retention: '30 days';
      recovery_point_objective: '1 hour';
      recovery_time_objective: '4 hours';
    };
    files: {
      frequency: 'real-time sync';
      geo_redundancy: true;
      backup_regions: ['us-east-1', 'ap-northeast-1'];
    };
  };
  failover: {
    database: 'automatic within 30 seconds';
    application: 'automatic within 2 minutes';
    cdn: 'automatic routing';
  };
}
```

### 3. セキュリティ要件

#### 3.1 認証・認可
```typescript
interface SecurityRequirements {
  authentication: {
    method: 'JWT Token (Supabase Auth)';
    token_expiry: '1 hour';
    refresh_token_expiry: '30 days';
    password_policy: {
      min_length: 8;
      require_uppercase: true;
      require_lowercase: true;
      require_numbers: true;
      require_symbols: true;
      history_check: 5; // 過去5回のパスワード使用禁止
    };
    mfa_support: true;
    session_timeout: '8 hours idle';
  };
  authorization: {
    rbac: true; // Role-Based Access Control
    principle: 'least privilege';
    audit_trail: true;
  };
}
```

#### 3.2 データ保護
| 保護対象 | 保護方式 | 暗号化レベル |
|----------|----------|-------------|
| 通信データ | TLS 1.3 | AES-256 |
| 保存データ | AES暗号化 | AES-256-GCM |
| パスワード | bcrypt | cost factor 12 |
| 個人情報 | フィールド暗号化 | AES-256-CBC |
| 位置情報 | ハッシュ化 | SHA-256 |

#### 3.3 セキュリティ監視
```typescript
interface SecurityMonitoring {
  intrusion_detection: {
    failed_login_threshold: 5;
    ip_blocking_duration: '15 minutes';
    rate_limiting: true;
    geo_blocking: ['known malicious IPs'];
  };
  audit_logging: {
    login_attempts: true;
    data_access: true;
    admin_operations: true;
    retention_period: '2 years';
  };
  vulnerability_scanning: {
    automated_scans: 'weekly';
    dependency_checks: 'daily';
    penetration_testing: 'quarterly';
  };
}
```

#### 3.4 プライバシー保護
- **GDPR準拠**: データポータビリティ、削除権の実装
- **個人情報保護法準拠**: 同意取得、目的外利用の禁止
- **データ匿名化**: 統計処理時の個人特定情報除去
- **Cookie Policy**: 必要最小限のCookie使用

### 4. 拡張性要件

#### 4.1 水平スケーリング
```typescript
interface ScalabilityTargets {
  user_growth: {
    current_capacity: '1,000 users';
    target_capacity: '10,000 users';
    scaling_timeline: '6 months';
  };
  store_growth: {
    current_capacity: '100 stores';
    target_capacity: '1,000 stores';
    scaling_timeline: '12 months';
  };
  data_volume: {
    database_size: {
      current: '10 GB';
      projected_1_year: '100 GB';
      projected_3_year: '1 TB';
    };
    file_storage: {
      current: '1 GB';
      projected_1_year: '50 GB';
      projected_3_year: '500 GB';
    };
  };
}
```

#### 4.2 アーキテクチャ拡張性
- **マイクロサービス対応**: 機能単位でのサービス分離
- **API Gateway**: 統一エンドポイントでの負荷分散
- **CDN活用**: 静的コンテンツの高速配信
- **キャッシュ戦略**: Redis活用による応答性能向上

### 5. 運用性要件

#### 5.1 監視・ログ
```typescript
interface MonitoringRequirements {
  application_monitoring: {
    apm_tool: 'Vercel Analytics + Sentry';
    metrics: [
      'response_time',
      'error_rate',
      'throughput',
      'cpu_usage',
      'memory_usage'
    ];
    alerting_threshold: {
      error_rate: '> 1%';
      response_time: '> 5 seconds';
      availability: '< 99.9%';
    };
  };
  business_monitoring: {
    kpi_tracking: [
      'daily_active_users',
      'clock_in_success_rate',
      'shift_generation_success_rate',
      'user_satisfaction_score'
    ];
    dashboard_update_frequency: 'real-time';
  };
  log_management: {
    structured_logging: true;
    log_levels: ['ERROR', 'WARN', 'INFO', 'DEBUG'];
    retention_policy: {
      error_logs: '1 year';
      access_logs: '3 months';
      audit_logs: '7 years';
    };
  };
}
```

#### 5.2 デプロイメント
```typescript
interface DeploymentStrategy {
  ci_cd_pipeline: {
    source_control: 'Git (GitHub)';
    build_automation: 'GitHub Actions';
    testing_stages: [
      'unit_tests',
      'integration_tests',
      'e2e_tests',
      'security_tests'
    ];
    deployment_strategy: 'blue-green';
    rollback_capability: 'automatic on failure';
  };
  environment_management: {
    development: 'feature branches';
    staging: 'release candidates';
    production: 'stable releases';
    hotfix: 'emergency patches';
  };
  release_frequency: {
    major_releases: 'quarterly';
    minor_releases: 'monthly';
    patch_releases: 'as needed';
    security_patches: 'within 24 hours';
  };
}
```

### 6. 互換性要件

#### 6.1 ブラウザ対応
| ブラウザ | 最小バージョン | 対応レベル |
|----------|---------------|-----------|
| Chrome | 90+ | Full |
| Firefox | 88+ | Full |
| Safari | 14+ | Full |
| Edge | 90+ | Full |
| モバイルSafari | iOS 14+ | Full |
| Chrome Mobile | Android 8+ | Full |

#### 6.2 デバイス対応
```typescript
interface DeviceCompatibility {
  desktop: {
    min_resolution: '1024x768';
    recommended_resolution: '1920x1080';
  };
  tablet: {
    min_resolution: '768x1024';
    orientation: 'portrait and landscape';
  };
  smartphone: {
    min_resolution: '375x667';
    orientation: 'portrait primary';
    pwa_support: true;
  };
  responsive_breakpoints: {
    mobile: '< 768px';
    tablet: '768px - 1023px';
    desktop: '>= 1024px';
  };
}
```

### 7. 法的・コンプライアンス要件

#### 7.1 データ保護法令
- **個人情報保護法**: 個人情報の適切な取得・利用・管理
- **GDPR**: EU居住者の個人データ保護（将来対応）
- **労働基準法**: 勤怠データの適切な記録・保存
- **電子帳簿保存法**: 勤怠記録の電子保存要件

#### 7.2 システム監査
```typescript
interface AuditRequirements {
  internal_audit: {
    frequency: 'quarterly';
    scope: ['security', 'performance', 'compliance'];
    documentation: 'audit trail maintenance';
  };
  external_audit: {
    frequency: 'annually';
    certification_target: 'ISO 27001';
    penetration_testing: 'bi-annually';
  };
  compliance_monitoring: {
    automated_checks: 'daily';
    manual_reviews: 'monthly';
    compliance_reports: 'quarterly';
  };
}
```

### 8. 品質要件

#### 8.1 信頼性
```typescript
interface ReliabilityTargets {
  defect_rate: {
    target: '< 0.1% of transactions';
    measurement: 'error rate monitoring';
  };
  data_integrity: {
    backup_verification: 'daily';
    corruption_detection: 'automated checksums';
    recovery_testing: 'monthly';
  };
  transaction_consistency: {
    acid_compliance: true;
    distributed_transaction_support: true;
  };
}
```

#### 8.2 保守性
- **コードカバレッジ**: 80%以上
- **技術文書**: コード変更時の同期更新
- **ログ設計**: 問題特定のための十分な情報
- **エラーハンドリング**: 適切なエラーメッセージと復旧手順

## パフォーマンステスト計画

### 負荷テストシナリオ
```typescript
interface LoadTestScenarios {
  normal_load: {
    concurrent_users: 100;
    duration: '30 minutes';
    ramp_up_time: '5 minutes';
  };
  peak_load: {
    concurrent_users: 500;
    duration: '15 minutes';
    ramp_up_time: '3 minutes';
  };
  stress_test: {
    concurrent_users: 1000;
    duration: '10 minutes';
    break_point_detection: true;
  };
  endurance_test: {
    concurrent_users: 200;
    duration: '8 hours';
    memory_leak_detection: true;
  };
}
```

## 運用監視ダッシュボード

### KPIメトリクス
1. **システム健全性**: 稼働率、応答時間、エラー率
2. **ビジネスメトリクス**: DAU、打刻成功率、機能利用率
3. **セキュリティメトリクス**: 攻撃検知、認証失敗率
4. **リソースメトリクス**: CPU、メモリ、ディスク、ネットワーク

### アラート設定
```typescript
interface AlertConfiguration {
  critical_alerts: {
    system_down: 'immediate SMS + email';
    security_breach: 'immediate phone call';
    data_corruption: 'immediate escalation';
  };
  warning_alerts: {
    high_response_time: 'email within 5 minutes';
    resource_threshold: 'email within 15 minutes';
    failed_backups: 'email within 30 minutes';
  };
}
```

## 関連ドキュメント
- 05_API仕様書.md
- 07_テスト計画書.md
- 08_運用・保守マニュアル.md